!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e){e.fn.extend({imageUpload:function(i){e.fn.imageUpload.defaults={skinName:"default-skin",selectMax:3,fileMax:3,fileSize:5242880,fileType:/\/(?:jpeg|png|bmp)/i,uploadUrl:null,uploadName:"imagefile",imageInputName:"path",resultKey:"path",uploadSuccess:null,zoomable:!0,canvas:{enable:!1,maxSize:5242880,maxPixel:4e6,tilePixel:2073600,quality:.5},thumbnail:{enable:!1,resultKey:"thumbPath",thumbInputName:"thumbPath"},description:{enable:!1,descInputName:"description",defaultValue:"",placeholder:"请输入该图片描述...",allowed:200,warning:25,cssWarning:"warning",cssExceeded:"exceeded",counterText:"剩余字符：",counterExceeded:"超出字符："},message:{tipsSelectMax:"最多同时只可上传 __SELECTMAX__ 张图片。",tipsFileMax:"最多只可上传 __FILEMAX__ 张图片。",tipsFileSize:"图片大小不能超过 __FILESIZE__M。",tipsFileType:"只支持jpg、png、bmp格式图片。",textButton:"点击添加图片",tipsButton:"支持jpg，png，bmp格式"},customMessage:{selectMax:null,fileMax:null,fileSize:null,fileType:null},data:{imageData:{}}};var a=e(this),t=e.extend(!0,{},e.fn.imageUpload.defaults,i),n={htmlBuffer:'<div class="upload-image '+t.skinName+'"><div style="display:none"><input type="file" class="upload-choose" multiple ><div class="pic-list"></div></div><div class="upload-box"><div class="upload-icon"><div class="icon-wrapper"><div class="icon-plus-x"></div><div class="icon-plus-y"></div></div></div><em>'+t.message.textButton+"</em><p>"+t.message.tipsButton+'</p></div><ul class="img-list clearfix"></ul></div>',msgFormat:function(e,i){return e.replace(/__SELECTMAX__/g,i).replace(/__FILEMAX__/g,i).replace(/__FILESIZE__/g,i)},upload:function(i,n,o,l){for(var d=this,r=window.atob(i.split(",")[1]),p=new Uint8Array(r.length),c=0,u=0;u<r.length;u++)p[u]=r.charCodeAt(u);var g=s.getBlob([p],n.type),m=s.getFormData();m.append(t.uploadName,g,n.name),e.ajax({type:"POST",url:t.uploadUrl,data:m,cache:!1,processData:!1,contentType:!1,success:function(i){var n=i||{},r=n[t.resultKey]?"上传成功":"上传失败";console.log(r+"："+n[t.resultKey]),o.find(".upload-progress span").css("height",0),o.find(".upload-progress .pecent").text("").hide(),o.find(".upload-progress").append('<em><i class="success"></i><p>上传成功</p></em>'),o.find(".upload-progress em").css({top:o.find(".upload-progress").height()/2-o.find(".upload-progress em").height()/2,left:o.find(".upload-progress").width()/2-o.find(".upload-progress em").width()/2}),setTimeout(function(){o.find(".upload-progress em").fadeOut(200)},1e3),n[t.resultKey]&&(o.addClass("success").append('<input class="path-input" name="'+t.imageInputName+'" type="text" value="'+n[t.resultKey]+'" style="display: none;"/>'),t.thumbnail.enable&&o.addClass("success").append('<input class="thumb-path-input" name="'+t.thumbnail.thumbInputName+'" type="text" value="'+n[t.thumbnail.resultKey]+'" style="display: none;"/>'),t.description.enable&&(o.append('<div class="mask">添加描述</div><textarea class="description-input" name="'+t.description.descInputName+'" type="text" style="display: none;">'+t.description.defaultValue+"</textarea>"),o.find(".mask").mousedown(function(e){e.stopPropagation()}).click(function(){var i=e(this).siblings(".description-input"),a="";a+='<div class="description-box">',a+='<div class="description-header clearfix">',a+='<div class="header-title">描述</div>',a+='<div class="count-tips">剩余字符：<em>'+t.description.allowed+"</em></div>",a+="</div>",a+='<textarea class="description-edit" placeholder="'+t.description.placeholder+'">'+s.decodeTextAreaString(i.val())+"</textarea> ",a+='<div class="description-group">',a+='<div class="description-btn button btn-primary btn-confirm">确定</div> <div class="description-btn button btn-normal btn-cancel">取消</div>',a+="</div>",a+="</div>",e(".page-dialog").remove(),e("body").append('<div class="page-dialog"><div class="page-mask"></div><div class="dialog-box"></div></div>'),e(".page-dialog .dialog-box").append(a).css({top:e(window).height()/2-e(".page-dialog .dialog-box").height()/2,left:e(window).width()/2-e(".page-dialog .dialog-box").width()/2});var n=e(".page-dialog .description-header .count-tips"),o=e(".page-dialog .description-edit");d.calculate(n,o),o.keyup(function(){d.calculate(n,o)}).change(function(){d.calculate(n,o)}),e(".page-dialog .btn-confirm").click(function(){t.description.allowed-o.val().length<0?o.addClass("warning"):(i.val(s.encodeTextAreaString(e(".page-dialog .description-box .description-edit").val())),e(".page-dialog").remove(),o.removeClass("warning"))}),e(".page-dialog .btn-cancel, .page-dialog .page-mask").click(function(){e(".page-dialog").remove()})})),"function"==typeof t.uploadSuccess&&t.uploadSuccess(a,l,o))},error:function(){o.find(".upload-progress span").css("height",0),o.find(".upload-progress .pecent").text("").hide(),o.find(".upload-progress").append('<em><i class="failed"></i><p>上传失败</p></em>'),o.find(".upload-progress em").css({top:o.find(".upload-progress").height()/2-o.find(".upload-progress em").height()/2,left:o.find(".upload-progress").width()/2-o.find(".upload-progress em").width()/2})},xhr:function(){var i=e.ajaxSettings.xhr();return i.upload&&i.upload.addEventListener("progress",function(e){e.lengthComputable&&(c=e.loaded/e.total*100,o.find(".upload-progress span").css("height",100-c+"%"),o.find(".upload-progress .pecent").text(parseInt(c)+"%").css({top:o.find(".upload-progress").height()/2-o.find(".upload-progress .pecent").height()/2,left:o.find(".upload-progress").width()/2-o.find(".upload-progress .pecent").width()/2}))},!1),i}})},compress:function(e){var i,a,n=document.createElement("canvas"),s=n.getContext("2d"),o=document.createElement("canvas"),l=o.getContext("2d"),d=e.src.length,r=e.width,p=e.height;if((i=r*p/t.canvas.maxPixel)>1?(r/=i=Math.sqrt(i),p/=i):i=1,n.width=r,n.height=p,s.fillStyle="#fff",s.fillRect(0,0,n.width,n.height),(a=r*p/t.canvas.tilePixel)>1){var c=~~(r/(a=~~(Math.sqrt(a)+1))),u=~~(p/a);o.width=c,o.height=u;for(var g=0;g<a;g++)for(var m=0;m<a;m++)l.drawImage(e,g*c*i,m*u*i,c*i,u*i,0,0,c,u),s.drawImage(o,g*c,m*u,c,u)}else s.drawImage(e,0,0,r,p);var f=n.toDataURL("image/jpeg",t.canvas.quality);return console.log("压缩前："+d),console.log("压缩后："+f.length),console.log("压缩率："+~~(100*(d-f.length)/d)+"%"),o.width=o.height=n.width=n.height=0,f},calculate:function(e,i){var a=i.val().length,n=t.description.allowed-a;n<=t.description.warning&&n>=0?e.addClass(t.description.cssWarning):e.removeClass(t.description.cssWarning),n<0?e.addClass(t.description.cssExceeded).html(t.description.counterExceeded+"<em>"+-n+"</em>"):e.removeClass(t.description.cssExceeded).html(t.description.counterText+"<em>"+n+"</em>")},imageZoom:function(i){e("#outerdiv").remove(),e(document.body).append(e('<div id=outerdiv><img id=bigimg src="" /></div>').hide().fadeIn("fast")),e("#bigimg").attr("src",i),e("#outerdiv").click(function(){e(this).fadeOut("fast",function(){e(this).remove()})})},uninit:function(){var e=a.find(".upload-image");e.find(".upload-box").unbind("click"),e.find(".upload-choose").unbind("change"),e.find(".img-list li .delete").unbind("mousedown click"),t.zoomable&&e.find(".img-list li .zoom").unbind("mousedown click"),t.description.enable&&e.find(".img-list li .mask").unbind("mousedown click"),e.remove()},init:function(){var i=this;a.append(n.htmlBuffer);var o=a.find(".upload-image");if(void 0!==t.data.imageData&&t.data.imageData.length>0){var l="";for(var d in t.data.imageData)l+='<li class="success" style="background-image: url('+(void 0===t.data.imageData[d].namespace?"":t.data.imageData[d].namespace)+t.data.imageData[d][t.resultKey]+'">',l+='<div class="drag-wrapper"></div>',l+='<div class="button-group">',l+='<div class="delete" title="删除"></div>',t.zoomable&&(l+='<div class="zoom" title="缩放"></div>'),l+="</div>",l+='<input class="path-input" name="'+t.imageInputName+'" type="text" value="'+(void 0===t.data.imageData[d][t.resultKey]?"":t.data.imageData[d][t.resultKey])+'" style="display: none;"/>',t.thumbnail.enable&&(l+='<input class="thumb-path-input" name="'+t.thumbnail.thumbInputName+'" type="text" value="'+(void 0===t.data.imageData[d][t.thumbnail.resultKey]?"":t.data.imageData[d][t.thumbnail.resultKey])+'" style="display: none;"/>'),t.description.enable&&(l+='<div class="mask">添加描述</div>',l+='<textarea class="description-input" name="'+t.description.descInputName+'" type="text" style="display: none;">'+(void 0===t.data.imageData[d].description?t.description.defaultValue:t.data.imageData[d].description)+"</textarea>"),l+="</li>";o.find(".img-list").append(e(l))}o.find(".upload-box").click(function(){o.find(".upload-choose").click()}),o.find(".img-list li .delete").mousedown(function(e){e.stopPropagation()}).click(function(){e(this).parent(".button-group").parent("li").remove()}),o.find(".img-list li .zoom").mousedown(function(e){e.stopPropagation()}).click(function(){i.imageZoom(e(this).parent(".button-group").parent("li").css("background-image").replace("url(","").replace(")","").replace(/\"/gi,""))}),t.description.enable&&o.find(".img-list li .mask").mousedown(function(e){e.stopPropagation()}).click(function(){var a=e(this).siblings(".description-input"),n="";n+='<div class="description-box">',n+='<div class="description-header clearfix">',n+='<div class="header-title">描述</div>',n+='<div class="count-tips">剩余字符：<em>'+t.description.allowed+"</em></div>",n+="</div>",n+='<textarea class="description-edit" placeholder="'+t.description.placeholder+'">'+s.decodeTextAreaString(a.val())+"</textarea> ",n+='<div class="description-group">',n+='<div class="description-btn button btn-primary btn-confirm">确定</div> <div class="description-btn button btn-normal btn-cancel">取消</div>',n+="</div>",n+="</div>",e(".page-dialog").remove(),e("body").append('<div class="page-dialog"><div class="page-mask"></div><div class="dialog-box"></div></div>'),e(".page-dialog .dialog-box").append(n).css({top:e(window).height()/2-e(".page-dialog .dialog-box").height()/2,left:e(window).width()/2-e(".page-dialog .dialog-box").width()/2});var o=e(".page-dialog .description-header .count-tips"),l=e(".page-dialog .description-edit");i.calculate(o,l),l.keyup(function(){i.calculate(o,l)}).change(function(){i.calculate(o,l)}),e(".page-dialog .btn-confirm").click(function(){t.description.allowed-l.val().length<0?l.addClass("warning"):(a.val(s.encodeTextAreaString(e(".page-dialog .description-box .description-edit").val())),e(".page-dialog").remove(),l.removeClass("warning"))}),e(".page-dialog .btn-cancel, .page-dialog .page-mask").click(function(){e(".page-dialog").remove()})}),o.find(".upload-choose").change(function(){if(this.files.length){var a=Array.prototype.slice.call(this.files);if(a.length>t.selectMax)"function"==typeof t.customMessage.selectMax?t.customMessage.selectMax():alert(n.msgFormat(t.message.tipsSelectMax,t.selectMax));else a.forEach(function(s,l){if(o.find(".img-list li.success").length>=t.fileMax||a.length>t.fileMax-o.find(".img-list li.success").length)"function"==typeof t.customMessage.fileMax?t.customMessage.fileMax():alert(n.msgFormat(t.message.tipsFileMax,t.fileMax));else if(t.fileType.test(s.type)){if(~~t.fileSize&&s.size>t.fileSize)return console.log(s.size),void("function"==typeof t.customMessage.fileSize?t.customMessage.fileSize():alert(n.msgFormat(t.message.tipsFileSize,parseFloat((t.fileSize/1024/1024).toFixed(2)))));var d=new FileReader,r=document.createElement("li");r.innerHTML='<div class="drag-wrapper"></div><div class="button-group"><div class="delete" title="删除"></div>'+(t.zoomable?'<div class="zoom" title="缩放"></div>':"")+'</div><div class="upload-progress"><span></span><div class="pecent"></div></div>',o.find(".img-list").append(e(r)),e(r).find(".delete").mousedown(function(e){e.stopPropagation()}).click(function(){e(this).parent(".button-group").parent("li").remove()}),e(r).find(".zoom").mousedown(function(e){e.stopPropagation()}).click(function(){i.imageZoom(e(r).css("background-image").replace("url(","").replace(")","").replace(/\"/gi,""))}),d.onload=function(){var a=this.result,n=new Image;if(n.src=a,e(r).css("background-image","url("+a+")"),t.canvas.enable){if(a.length<=t.canvas.maxSize)return n=null,void i.upload(a,s,e(r),o);function l(){var a=i.compress(n);i.upload(a,s,e(r),o),n=null}n.complete?l():n.onload=l}else i.upload(a,s,e(r),o)},d.readAsDataURL(s)}else"function"==typeof t.customMessage.fileType?t.customMessage.fileType():alert(t.message.tipsFileType)}),e(this).val("")}})}},s={getBlob:function(e,i){try{return new Blob(e,{type:i})}catch(t){var a=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MSBlobBuilder);return e.forEach(function(e){a.append(e)}),a.getBlob(i)}},getFormData:function(){return~navigator.userAgent.indexOf("Android")&&~navigator.vendor.indexOf("Google")&&!~navigator.userAgent.indexOf("Chrome")&&navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop()<=534?new this.FormDataShim:new FormData},FormDataShim:function(){console.warn("using formdata shim");var e=this,i=[],a=Array(21).join("-")+(+new Date*(1e16*Math.random())).toString(36),t=XMLHttpRequest.prototype.send;this.append=function(e,t,n){i.push("--"+a+'\r\nContent-Disposition: form-data; name="'+e+'"'),t instanceof Blob?(i.push('; filename="'+(n||"blob")+'"\r\nContent-Type: '+t.type+"\r\n\r\n"),i.push(t)):i.push("\r\n\r\n"+t),i.push("\r\n")},XMLHttpRequest.prototype.send=function(n){var s,o,l=this;n===e?(i.push("--"+a+"--\r\n"),o=getBlob(i),(s=new FileReader).onload=function(){t.call(l,s.result)},s.onerror=function(e){throw e},s.readAsArrayBuffer(o),this.setRequestHeader("Content-Type","multipart/form-data; boundary="+a),XMLHttpRequest.prototype.send=t):t.call(this,n)}},encodeTextAreaString:function(e){return e.replace(/\r\n/g,"<br/>").replace(/\n/g,"<br/>").replace(/\s\s/g," &nbsp;")},decodeTextAreaString:function(e){return e.replace(/<br\/>/gi,"\n").replace(/ &nbsp;/g,"  ")}};return"destroy"==i?(n.uninit(),a):(n.init(),a)}})});