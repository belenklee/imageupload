/**
 * Created by Belenk Lee on 2017/9/7.
 * Last update by 2018/10/15.
 */

(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory)}else{factory(jQuery)}}(function($){$.fn.extend({"imageUpload":function(options){$.fn.imageUpload.defaults={skinName:"default-skin",selectMax:3,fileMax:3,fileSize:5*1024*1024,fileType:/\/(?:jpeg|png|bmp)/i,uploadUrl:null,uploadName:"imagefile",imageInputName:"path",resultKey:"path",uploadSuccess:null,zoomable:true,canvas:{enable:false,maxSize:5*1024*1024,maxPixel:4000000,tilePixel:1920*1080,quality:0.5},description:{enable:true,descInputName:"description",placeholder:"请输入该图片描述...",allowed:200,warning:25,cssWarning:"warning",cssExceeded:"exceeded",counterText:"剩余字符：",counterExceeded:"超出字符："},message:{tipsSelectMax:"最多同时只可上传 __SELECTMAX__ 张图片。",tipsFileMax:"最多只可上传 __FILEMAX__ 张图片。",tipsFileSize:"图片大小不能超过 __FILESIZE__M。",tipsFileType:"只支持jpg、png、bmp格式图片。",textButton:"点击添加图片",tipsButton:"支持jpg，png，bmp格式"},customMessage:{selectMax:null,fileMax:null,fileSize:null,fileType:null},data:{imageData:{}}};var $element=$(this),settings=$.extend(true,{},$.fn.imageUpload.defaults,options);var imageUpload={htmlBuffer:'<div class="upload-image '+settings.skinName+'">'+'<div style="display:none">'+'<input type="file" class="upload-choose" multiple >'+'<div class="pic-list"></div>'+"</div>"+'<div class="upload-box">'+'<div class="upload-icon">'+'<div class="icon-wrapper">'+'<div class="icon-plus-x"></div>'+'<div class="icon-plus-y"></div>'+"</div>"+"</div>"+"<em>"+settings.message.textButton+"</em>"+"<p>"+settings.message.tipsButton+"</p>"+"</div>"+'<ul class="img-list clearfix">'+"</ul>"+"</div>",msgFormat:function(template,msg){return template.replace(/__SELECTMAX__/g,msg).replace(/__FILEMAX__/g,msg).replace(/__FILESIZE__/g,msg)},upload:function(basestr,file,$li,$content){var context=this;var text=window.atob(basestr.split(",")[1]);var buffer=new Uint8Array(text.length);var pecent=0;for(var i=0;i<text.length;i++){buffer[i]=text.charCodeAt(i)}var blob=utils.getBlob([buffer],file.type);var formdata=utils.getFormData();formdata.append(settings.uploadName,blob,file.name);$.ajax({type:"POST",url:settings.uploadUrl,data:formdata,cache:false,processData:false,contentType:false,success:function(data){var jsonData=data;var imagedata=jsonData||{};var text=imagedata[settings.resultKey]?"上传成功":"上传失败";console.log(text+"："+imagedata[settings.resultKey]);$li.find(".progress span").css("height",0);$li.find(".progress .pecent").text("").hide();$li.find(".progress").append('<em><i class="success"></i><p>上传成功</p></em>');$li.find(".progress em").css({"top":$li.find(".progress").height()/2-$li.find(".progress em").height()/2,"left":$li.find(".progress").width()/2-$li.find(".progress em").width()/2});setTimeout(function(){$li.find(".progress em").fadeOut(200)},1000);if(!imagedata[settings.resultKey]){return}$li.addClass("success").append('<input class="path-input" name="'+settings.imageInputName+'" type="text" value="'+imagedata[settings.resultKey]+'" style="display: none;"/>');if(settings.description.enable){$li.append('<div class="mask">添加描述</div><input class="description-input" name="'+settings.description.descInputName+'" type="text" value="" style="display: none;"/>');$li.find(".mask").mousedown(function(e){e.stopPropagation()}).click(function(){var $descInput=$(this).siblings(".description-input");var html="";html+='<div class="description-box">';html+='<div class="description-header clearfix">';html+='<div class="header-title">描述</div>';html+='<div class="count-tips">剩余字符：<em>'+settings.description.allowed+"</em></div>";html+="</div>";html+='<textarea class="description-edit" placeholder="'+settings.description.placeholder+'">'+$descInput.val()+"</textarea> ";html+='<div class="description-group">';html+='<div class="description-btn button btn-primary btn-confirm">确定</div> <div class="description-btn button btn-normal btn-cancel">取消</div>';html+="</div>";html+="</div>";$(".page-dialog").remove();$("body").append('<div class="page-dialog"><div class="page-mask"></div><div class="dialog-box"></div></div>');$(".page-dialog .dialog-box").append(html).css({"top":$(window).height()/2-$(".page-dialog .dialog-box").height()/2,"left":$(window).width()/2-$(".page-dialog .dialog-box").width()/2});var $tips=$(".page-dialog .description-header .count-tips");var $textarea=$(".page-dialog .description-edit");context.calculate($tips,$textarea);$textarea.keyup(function(){context.calculate($tips,$textarea)}).change(function(){context.calculate($tips,$textarea)});$(".page-dialog .btn-confirm").click(function(){if(settings.description.allowed-$textarea.val().length<0){$textarea.addClass("warning")}else{$descInput.val($(".page-dialog .description-box .description-edit").val());$(".page-dialog").remove();$textarea.removeClass("warning")}});$(".page-dialog .btn-cancel").click(function(){$(".page-dialog").remove()})})}if(typeof(settings.uploadSuccess)=="function"){settings.uploadSuccess($element,$content,$li)}},error:function(){$li.find(".progress span").css("height",0);$li.find(".progress .pecent").text("").hide();
$li.find(".progress").append('<em><i class="failed"></i><p>上传失败</p></em>');$li.find(".progress em").css({"top":$li.find(".progress").height()/2-$li.find(".progress em").height()/2,"left":$li.find(".progress").width()/2-$li.find(".progress em").width()/2})},xhr:function(){var xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener("progress",function(e){if(e.lengthComputable){pecent=e.loaded/e.total*100;$li.find(".progress span").css("height",100-pecent+"%");$li.find(".progress .pecent").text(parseInt(pecent)+"%").css({"top":$li.find(".progress").height()/2-$li.find(".progress .pecent").height()/2,"left":$li.find(".progress").width()/2-$li.find(".progress .pecent").width()/2})}},false)}return xhr}})},compress:function(img){var pCanvas=document.createElement("canvas");var pctx=pCanvas.getContext("2d");var tCanvas=document.createElement("canvas");var tctx=tCanvas.getContext("2d");var initSize=img.src.length;var width=img.width;var height=img.height;var ratio;if((ratio=width*height/settings.canvas.maxPixel)>1){ratio=Math.sqrt(ratio);width/=ratio;height/=ratio}else{ratio=1}pCanvas.width=width;pCanvas.height=height;pctx.fillStyle="#fff";pctx.fillRect(0,0,pCanvas.width,pCanvas.height);var count;if((count=width*height/settings.canvas.tilePixel)>1){count=~~(Math.sqrt(count)+1);var nw=~~(width/count);var nh=~~(height/count);tCanvas.width=nw;tCanvas.height=nh;for(var i=0;i<count;i++){for(var j=0;j<count;j++){tctx.drawImage(img,i*nw*ratio,j*nh*ratio,nw*ratio,nh*ratio,0,0,nw,nh);pctx.drawImage(tCanvas,i*nw,j*nh,nw,nh)}}}else{pctx.drawImage(img,0,0,width,height)}var ndata=pCanvas.toDataURL("image/jpeg",settings.canvas.quality);console.log("压缩前："+initSize);console.log("压缩后："+ndata.length);console.log("压缩率："+~~(100*(initSize-ndata.length)/initSize)+"%");tCanvas.width=tCanvas.height=pCanvas.width=pCanvas.height=0;return ndata},calculate:function($tips,$textarea){var count=$textarea.val().length;var available=settings.description.allowed-count;if(available<=settings.description.warning&&available>=0){$tips.addClass(settings.description.cssWarning)}else{$tips.removeClass(settings.description.cssWarning)}if(available<0){$tips.addClass(settings.description.cssExceeded).html(settings.description.counterExceeded+"<em>"+-available+"</em>")}else{$tips.removeClass(settings.description.cssExceeded).html(settings.description.counterText+"<em>"+available+"</em>")}},imageZoom:function(img){var html="";var outerdiv="outerdiv";var bigimg="bigimg";html+="<div id="+outerdiv+">";html+="<img id="+bigimg+' src="" />';html+="</div>";$("#"+outerdiv).remove();$(document.body).append($(html).hide().fadeIn("fast"));$("#bigimg").attr("src",img);$("#"+outerdiv).click(function(){$(this).fadeOut("fast",function(){$(this).remove()})})},uninit:function(){var $content=$element.find(".upload-image");$content.find(".upload-box").unbind("click");$content.find(".upload-choose").unbind("change");$content.find(".img-list li .delete").unbind("mousedown click");if(settings.zoomable){$content.find(".img-list li .zoom").unbind("mousedown click")}if(settings.description.enable){$content.find(".img-list li .mask").unbind("mousedown click")}$content.remove()},init:function(){var context=this;$element.append(imageUpload.htmlBuffer);var $content=$element.find(".upload-image");if(typeof(settings.data.imageData)!="undefined"){if(settings.data.imageData.length>0){var li="";for(var i in settings.data.imageData){li+='<li class="success" style="background-image: url('+(typeof(settings.data.imageData[i].namespace)=="undefined"?"":settings.data.imageData[i].namespace)+settings.data.imageData[i][settings.resultKey]+'">';li+='<div class="drag-wrapper"></div>';li+='<div class="button-group">';li+='<div class="delete" title="删除"></div>';if(settings.zoomable){li+='<div class="zoom" title="缩放"></div>'}li+="</div>";if(settings.description.enable){li+='<div class="mask">添加描述</div>';li+='<input class="description-input" name="'+settings.description.descInputName+'" type="text" value="'+(typeof(settings.data.imageData[i].description)=="undefined"?"":settings.data.imageData[i].description)+'" style="display: none;"/>'}li+='<input class="path-input" name="'+settings.imageInputName+'" type="text" value="'+(typeof(settings.data.imageData[i].path)=="undefined"?"":settings.data.imageData[i][settings.resultKey])+'" style="display: none;"/>';li+="</li>"}$content.find(".img-list").append($(li))}}$content.find(".upload-box").click(function(){$content.find(".upload-choose").click()});$content.find(".img-list li .delete").mousedown(function(e){e.stopPropagation()}).click(function(){$(this).parent(".button-group").parent("li").remove()});$content.find(".img-list li .zoom").mousedown(function(e){e.stopPropagation()}).click(function(){context.imageZoom($(this).parent(".button-group").parent("li").css("background-image").replace("url(","").replace(")","").replace(/\"/gi,""))});if(settings.description.enable){$content.find(".img-list li .mask").mousedown(function(e){e.stopPropagation()}).click(function(){var $descInput=$(this).siblings(".description-input");
var html="";html+='<div class="description-box">';html+='<div class="description-header clearfix">';html+='<div class="header-title">描述</div>';html+='<div class="count-tips">剩余字符：<em>'+settings.description.allowed+"</em></div>";html+="</div>";html+='<textarea class="description-edit" placeholder="'+settings.description.placeholder+'">'+$descInput.val()+"</textarea> ";html+='<div class="description-group">';html+='<div class="description-btn button btn-primary btn-confirm">确定</div> <div class="description-btn button btn-normal btn-cancel">取消</div>';html+="</div>";html+="</div>";$(".page-dialog").remove();$("body").append('<div class="page-dialog"><div class="page-mask"></div><div class="dialog-box"></div></div>');$(".page-dialog .dialog-box").append(html).css({"top":$(window).height()/2-$(".page-dialog .dialog-box").height()/2,"left":$(window).width()/2-$(".page-dialog .dialog-box").width()/2});var $tips=$(".page-dialog .description-header .count-tips");var $textarea=$(".page-dialog .description-edit");context.calculate($tips,$textarea);$textarea.keyup(function(){context.calculate($tips,$textarea)}).change(function(){context.calculate($tips,$textarea)});$(".page-dialog .btn-confirm").click(function(){if(settings.description.allowed-$textarea.val().length<0){$textarea.addClass("warning")}else{$descInput.val($(".page-dialog .description-box .description-edit").val());$(".page-dialog").remove();$textarea.removeClass("warning")}});$(".page-dialog .btn-cancel").click(function(){$(".page-dialog").remove()})})}$content.find(".upload-choose").change(function(){if(!this.files.length){return}var files=Array.prototype.slice.call(this.files);if(files.length>settings.selectMax){if(typeof(settings.customMessage.selectMax)=="function"){settings.customMessage.selectMax()}else{alert(imageUpload.msgFormat(settings.message.tipsSelectMax,settings.selectMax))}return}files.forEach(function(file,i){if($content.find(".img-list li.success").length>=settings.fileMax||files.length>settings.fileMax-$content.find(".img-list li.success").length){if(typeof(settings.customMessage.fileMax)=="function"){settings.customMessage.fileMax()}else{alert(imageUpload.msgFormat(settings.message.tipsFileMax,settings.fileMax))}return}if(!settings.fileType.test(file.type)){if(typeof(settings.customMessage.fileType)=="function"){settings.customMessage.fileType()}else{alert(settings.message.tipsFileType)}return}if(~~settings.fileSize){if(file.size>settings.fileSize){console.log(file.size);if(typeof(settings.customMessage.fileSize)=="function"){settings.customMessage.fileSize()}else{alert(imageUpload.msgFormat(settings.message.tipsFileSize,parseFloat((settings.fileSize/1024/1024).toFixed(2))))}return}}var reader=new FileReader();var li=document.createElement("li");li.innerHTML=""+'<div class="drag-wrapper"></div>'+'<div class="button-group">'+'<div class="delete" title="删除"></div>'+(settings.zoomable?'<div class="zoom" title="缩放"></div>':"")+"</div>"+'<div class="progress">'+"<span></span>"+'<div class="pecent"></div>'+"</div>";$content.find(".img-list").append($(li));$(li).find(".delete").mousedown(function(e){e.stopPropagation()}).click(function(){$(this).parent(".button-group").parent("li").remove()});$(li).find(".zoom").mousedown(function(e){e.stopPropagation()}).click(function(){context.imageZoom($(li).css("background-image").replace("url(","").replace(")","").replace(/\"/gi,""))});reader.onload=function(){var result=this.result;var img=new Image();img.src=result;$(li).css("background-image","url("+result+")");if(settings.canvas.enable){if(result.length<=settings.canvas.maxSize){img=null;context.upload(result,file,$(li),$content);return}if(img.complete){callback()}else{img.onload=callback}function callback(){var data=context.compress(img);context.upload(data,file,$(li),$content);img=null}}else{context.upload(result,file,$(li),$content);return}};reader.readAsDataURL(file)});var $file=$(this);$file.val("")})}};var utils={getBlob:function(buffer,format){try{return new Blob(buffer,{type:format})}catch(e){var bb=new (window.BlobBuilder||window.WebKitBlobBuilder||window.MSBlobBuilder);buffer.forEach(function(buf){bb.append(buf)});return bb.getBlob(format)}},getFormData:function(){var isNeedShim=~navigator.userAgent.indexOf("Android")&&~navigator.vendor.indexOf("Google")&&!~navigator.userAgent.indexOf("Chrome")&&navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop()<=534;return isNeedShim?new this.FormDataShim():new FormData()},FormDataShim:function(){console.warn("using formdata shim");var o=this,parts=[],boundary=Array(21).join("-")+(+new Date()*(10000000000000000*Math.random())).toString(36),oldSend=XMLHttpRequest.prototype.send;this.append=function(name,value,filename){parts.push("--"+boundary+'\r\nContent-Disposition: form-data; name="'+name+'"');if(value instanceof Blob){parts.push('; filename="'+(filename||"blob")+'"\r\nContent-Type: '+value.type+"\r\n\r\n");parts.push(value)}else{parts.push("\r\n\r\n"+value)}parts.push("\r\n")};XMLHttpRequest.prototype.send=function(val){var fr,data,oXHR=this;
if(val===o){parts.push("--"+boundary+"--\r\n");data=getBlob(parts);fr=new FileReader();fr.onload=function(){oldSend.call(oXHR,fr.result)};fr.onerror=function(err){throw err};fr.readAsArrayBuffer(data);this.setRequestHeader("Content-Type","multipart/form-data; boundary="+boundary);XMLHttpRequest.prototype.send=oldSend}else{oldSend.call(this,val)}}}};if(options=="destroy"){imageUpload.uninit();return}else{imageUpload.init()}}})}));